name: Enforce Production Change Assurance

on:
  workflow_call:
    inputs:
      windows_file:
        required: false
        type: string
        default: .github/change-windows.yml
      timezone:
        required: false
        type: string
        default: UTC

jobs:
  block-prod-changes:
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout caller repository
        uses: actions/checkout@v4

      - name: Get changed files
        id: changes
        uses: tj-actions/changed-files@v45

      - name: Detect /prod/ changes
        run: |
          PROD_CHANGED=false
          for f in ${{ steps.changes.outputs.all_changed_files }}; do
            if [[ "$f" == *"/prod/"* ]]; then
              echo "Detected prod file change: $f"
              PROD_CHANGED=true
              break
            fi
          done
          echo "PROD_CHANGED=$PROD_CHANGED" >> $GITHUB_ENV

      - name: Check Change Assurance Window
        shell: bash
        run: |
          # Skip if the file is missing
          if [ ! -f "${{ inputs.windows_file }}" ]; then
            echo "âš ï¸ No change-windows.yml found at '${{ inputs.windows_file }}'. Skipping enforcement."
            echo "IN_CA_WINDOW=false" >> $GITHUB_ENV
            exit 0
          fi

          NOW=$(TZ=${{ inputs.timezone }} date +%s)
          IN_WINDOW=false

          COUNT=$(yq '.windows | length' "${{ inputs.windows_file }}")

          for i in $(seq 0 $((COUNT - 1))); do
            START=$(yq ".windows[$i].start" "${{ inputs.windows_file }}")
            END=$(yq ".windows[$i].end" "${{ inputs.windows_file }}")

            START_TS=$(date -d "$START" +%s)
            END_TS=$(date -d "$END" +%s)

            if [ "$NOW" -ge "$START_TS" ] && [ "$NOW" -le "$END_TS" ]; then
              IN_WINDOW=true
              echo "Matched change window: $START â†’ $END"
              break
            fi
          done

          echo "IN_CA_WINDOW=$IN_WINDOW" >> $GITHUB_ENV

      - name: Comment and Close PR
        if: env.PROD_CHANGED == 'true' && env.IN_CA_WINDOW == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "
          ðŸš« **Production Change Denied**

          Changes have been detected in a **prod** path.
          A strict **change assurance freeze** is currently in effect.

          Please refer to your repository's
          **change-windows.yml** for exact dates.

          If this change is business-critical,
          contact the Change Assurance team for guidance.
          "

          gh pr close ${{ github.event.pull_request.number }}
